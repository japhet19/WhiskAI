<instructions_for_orchestrate_goal>
    ultrathink: Based on `UserProvidedInput` (which will be a goal description, a plan file path, or a directive like 'continue_current'), and considering project context from memory files (`project_overview.md`, `architecture.md`, `active_context.md`), formulate a `ComprehensiveOrchestrationStrategy`. This strategy object MUST include: (a) `DeterminedGoalSlug` (string, derived or confirmed), (b) `GoalScopeDefinition` (clear string of what's in/out of the goal), (c) `MajorPhases` (ordered list of phase objects, each with at least: `PhaseName`, `PhaseObjective`, `PhaseDeliverables` (list), `Status` ('Not Started', 'In Progress', 'Completed'), `SuggestedActions` (list of strings, each a high-level action like 'CREATE_TASK: Design database schema' or 'PLAN_FEATURE: User authentication module' or 'USER_ACTION: Review wireframes with stakeholders')), (d) `KeyDependencies` (list mapping dependencies to phases), (e) `ResourceNeedsAssessment` (string, per phase or overall), (f) `CriticalRisksAndTimelineImpacts` (string), (g) `ParallelizationOpportunities` (string), (h) `OrchestrationPlanMarkdownContent` (a complete, well-structured markdown string for the `[DeterminedGoalSlug]-plan.md` file, reflecting all a-g elements, using XML-like tags for phases and actions for clarity if desired), (i) `InitialOrchestrationGuidance` (string, a brief summary of the immediate next step or question for the user based on the strategy, e.g., 'Propose creating the plan file', or if resuming, 'Confirm starting next task X from Phase Y'). This `ComprehensiveOrchestrationStrategy` will be the primary driver for the entire command.
    0.  <operational_guidelines>Throughout this command: (a) If any step results in an unexpected error from a tool or internal logic, clearly report the error, the step where it occurred, and ask the user for guidance (e.g., retry, skip, provide more info, abort). (b) When prompting the user for input, always aim for clarity and specify what kind of information is most helpful for the current context or strategy.</operational_guidelines>
    1.  <role_adoption>Adopt Role: "You are an expert Project Orchestrator."</role_adoption>
    2.  <initial_input_processing_and_strategy_invocation>
        Parse `action_args` into `UserProvidedInput`. Read context memory files (`project_overview.md`, `architecture.md`, `active_context.md`).
        Invoke `ultrathink` with `UserProvidedInput` and context data to generate the `ComprehensiveOrchestrationStrategy`.
        Let `Strategy` be the `ComprehensiveOrchestrationStrategy` object returned by `ultrathink`.
        Set `DeterminedGoalSlug` from `Strategy.DeterminedGoalSlug`.
        Let `OrchestrationFilePath` be `./.claude/orchestration/{DeterminedGoalSlug}-plan.md`.
    2.  </initial_input_processing_and_strategy_invocation>
    3.  <plan_file_management_and_user_confirmation>
        If `UserProvidedInput` indicated a new goal (or `ultrathink` determined a new plan is needed based on input):
            Propose to the user: "Based on my `ultrathink` analysis of your goal '{UserProvidedInput}', I've formulated a comprehensive orchestration strategy. This includes a structured plan with phases like {Strategy.MajorPhases list of names}. Shall I create the detailed plan file at `{OrchestrationFilePath}` using this strategy? (y/n)".
            Upon 'y', write `Strategy.OrchestrationPlanMarkdownContent` to `OrchestrationFilePath`. Report success/failure. If failure, stop.
        Else (if resuming or using an existing plan file that `ultrathink` analyzed):
            Report to user: "I have analyzed the existing plan `{OrchestrationFilePath}` using `ultrathink`. My strategic re-evaluation suggests [Strategy.InitialOrchestrationGuidance]."
            If `Strategy.OrchestrationPlanMarkdownContent` represents an updated version of the plan (due to `ultrathink` suggesting modifications): 
                Ask the user: "My analysis suggests potential strategic improvements to the plan, such as [briefly list 1-2 key types of changes from Strategy.InitialOrchestrationGuidance if they imply structural plan changes, e.g., 're-prioritizing certain phases', 'adding a preparatory step for X']. Shall I update the plan file at `{OrchestrationFilePath}` with these strategic enhancements before we proceed? (y/n)".
                If 'y', write the updated `Strategy.OrchestrationPlanMarkdownContent` to `OrchestrationFilePath`. Report success/failure. If failure or 'n', proceed with the existing plan file content but keep the strategic insights in mind for guidance.
        Update `./.claude/memory/active_context.md` with `Active Orchestration Plan: {OrchestrationFilePath}`.
    3.  </plan_file_management_and_user_confirmation>
    4.  <orchestration_execution_loop>
        Instruct yourself: "I will now execute the orchestration based on the `ComprehensiveOrchestrationStrategy` and the plan file at `{OrchestrationFilePath}`. I will maintain `SessionState` with `CurrentPhaseName`, `CurrentActionIndex`."
        Present `Strategy.InitialOrchestrationGuidance` to the user if not already done. Confirm to proceed.
        Loop through `Strategy.MajorPhases` and their `SuggestedActions`:
        a.  Identify `CurrentPhase` and `CurrentAction` from `Strategy.MajorPhases` (or by reading and interpreting `{OrchestrationFilePath}` if it's the source of truth for dynamic state like task IDs generated mid-orchestration).
        b.  Report to user: "Processing action: '{CurrentAction}' for phase '{CurrentPhase.PhaseName}'."
        c.  Before proceeding with `CurrentAction`, instruct yourself: 'Consult `ComprehensiveOrchestrationStrategy` (specifically `KeyDependencies`, `CriticalRisksAndTimelineImpacts` for this phase: {CurrentPhase.PhaseName}) to ensure this action remains aligned and to anticipate any immediate follow-ups.'
            Process `CurrentAction`:
            If `CurrentAction` starts with "CREATE_TASK: ": Extract description, clarify if needed (consulting `Strategy` for context), invoke `/create_task`. Update `{OrchestrationFilePath}` with new task ID and status by editing the corresponding action line or a dedicated tasks section.
            Else if `CurrentAction` starts with "IMPLEMENT_TASK: ": Extract TaskID, invoke `/implement_task`. Update task status in `{OrchestrationFilePath}`.
            Else if `CurrentAction` starts with "PLAN_FEATURE: ": Extract description, invoke `/plan_feature`. Update `{OrchestrationFilePath}` with feature plan path.
            Else (general instruction, e.g., "USER_ACTION: Review X"): Present to user, await confirmation of completion. Update status in `{OrchestrationFilePath}`.
        d.  After each action, check its result. If the action failed, report the failure and ask the user: 'Action [{CurrentAction}] failed. Shall I stop this phase, attempt to retry this action, or skip to the next action in the phase? (stop/retry/skip)'. If the action was successful, proceed to the next action in the current phase autonomously. If the plan file explicitly contains a 'USER_CONFIRMATION_POINT: [message]' action, present the message and await user 'y' to proceed.
        e.  If all actions in a phase are complete, update phase status in `{OrchestrationFilePath}`. Instruct yourself: 'Phase "{CurrentPhase.PhaseName}" is complete. Before proposing the next phase, I will reflect on the `PhaseObjective`, `PhaseDeliverables`, and any `KeyDependencies` of the upcoming phase ({Strategy.MajorPhases[next phase index].PhaseName}) to ensure full readiness and context for its actions.' Then, propose moving to the next phase based on `Strategy.MajorPhases`.
        f.  If the plan file is modified (e.g. new Task ID added), re-read/re-parse relevant parts if needed for subsequent actions, or ensure `ultrathink`'s initial `Strategy` is robust enough to anticipate such dynamic information placeholders.
    4.  </orchestration_execution_loop>
</instructions_for_orchestrate_goal>